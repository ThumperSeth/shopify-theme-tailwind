{% comment %}theme-check-disable UndefinedObject{% endcomment %}
{%- assign fitment_info = product.metafields.global.fitment -%}

{%- if fitment_info.size > 0 -%}
  <fitment_info-preview class="fitment_info-preview">
    {%- liquid
      assign closest_location = fitment_info.first

      if closest_location.available
        render 'icon-tick'
      endif
    -%}

    <div class="fitment_info-info">
      {%- if closest_location.available -%}
        <p class="caption-large">{{ 'products.product.pickup_availability.pick_up_available_at_html' | t: location_name: closest_location.location.name }}</p>
        <p class="caption">{{ closest_location.pick_up_time }}</p>
        <button id="ShowPickupAvailabilityDrawer" class="fitment_info-button link link--text underlined-link" aria-haspopup="dialog">
          {%- if pick_up_availabilities.size == 1 -%}
            {{ 'products.product.pickup_availability.view_store_info' | t }}
          {%- else -%}
            {{ 'products.product.pickup_availability.check_other_stores' | t }}
          {%- endif -%}
        </button>
      {%- else -%}
        <p class="caption-large">{{ 'products.product.pickup_availability.pick_up_unavailable_at_html' | t: location_name: closest_location.location.name }}</p>
        {%- if pick_up_availabilities.size > 1 -%}
          <button id="ShowPickupAvailabilityDrawer" class="fitment_info-button link link--text underlined-link" aria-haspopup="dialog">{{ 'products.product.pickup_availability.check_other_stores' | t }}</button>
        {%- endif -%}
      {%- endif -%}
    </div>
  </fitment_info-preview>

  <fitment_info-drawer tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="PickupAvailabilityHeading">
    <div class="fitment_info-header">
      <h2 class="h3 fitment_info-drawer-title" id="PickupAvailabilityHeading">{{ product_variant.product.title | escape }}</h2>
      <button class="fitment_info-drawer-button" type="button" aria-label="{{ 'accessibility.close' | t }}">{%- render 'icon-close' -%}</button>
    </div>
    <p>{{ product.metafields.global.fitment }}</p>

    <ul class="fitment_info-list list-unstyled" role="list" data-store-availability-drawer-content>
      {%- for availability in pick_up_availabilities -%}
        <li class="fitment_info-list__item">
          <h3 class="h4">{{ availability.location.name | escape }}</h3>
          <p class="fitment_info-preview caption-large">
            {%- if availability.available -%}
              {% render 'icon-tick' %} {{ 'products.product.pickup_availability.pick_up_available' | t }}, {{ availability.pick_up_time | downcase }}
            {%- endif -%}
          </p>

          {%- assign address = availability.location.address -%}
          <address class="fitment_info-address">
            {{ address | format_address }}

            {%- if address.phone.size > 0 -%}
              <p>{{ address.phone }}</p>
            {%- endif -%}
          </address>
        </li>
      {%- endfor -%}
    </ul>
  </fitment_info-drawer>
{%- endif -%}
